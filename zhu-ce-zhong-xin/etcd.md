ETCD

## 资料

> [https://zhuanlan.zhihu.com/p/96428375?from\_voters\_page=true](https://zhuanlan.zhihu.com/p/96428375?from_voters_page=true)
>
> [https://segmentfault.com/a/1190000020742981](https://segmentfault.com/a/1190000020742981)
>
> [https://www.cnblogs.com/softidea/p/6517959.html](https://www.cnblogs.com/softidea/p/6517959.html)

## 简述

> 分布式，靠key-value存储的分布式系统，不仅提供存储系统，还提供配置共享和服务发现
>
> 通过 raft算法报纸一致性，3各节点1故障，5个节点2个故障，一个主节点多个从节点。每个节点都存储完整的数据

## 特点

> * 简单：基于HTTP+JSON的API让你用curl就可以轻松使用。
>
> * 安全：可选SSL客户认证机制。
>
> * 快速：每个实例每秒支持一千次写操作。
>
> * 可信：使用Raft算法充分实现了分布式。

## 应用场景

> * 服务发现
> * 消息发布与订阅
> * 负载均衡
> * 分布式通知和x协调
> * 分布式锁，分布式队列
> * 集群选举和leader竞选

## 与zk的区别

> 一致性协议  etcd 使用raft  zk使用ZAB
>
> 运维方面  etcd比zk更方便运维
>
> API etcd提供 http+json，grpc接口，跨平台语言，zk需要客户端
>
> 访问安全 zk支持https，zk这方面缺失

## 主节点 选举

> Raft利用Timer来初始化选举流程，率先完成初始化的会给其他节点发送成为主节点的请求。其他节点收到后给他投一票
>
> 如果票数被瓜分，raft启用随机选举延时，重新发起一轮新的选举的时候有些server就无法参加选举
>
> > 流程。
> >
> > 三个角色  主节点 从节点  候选者
> >
> > 主节点会给从节点发送心跳。如果一段时间为从节点未收到心跳，从节点变为候选者，发起一次投票。未避免被瓜分，发起投票的时机会被随机延迟。如果候选者收到主节点的心跳会变为从节点
> >
> > 重点 raft会保证包含了集群最新提交的节点成为主节点。这样子简化了流程，缩短了集群恢复时间。
>
> 发起投票的时候 term+1
>
> 如果成为了主，这个定期给其他发送心跳
>
> 如果其他的成了主，更新本地的term 为主的term

## 写入成功

> * 写请求被主节点处理并且发送给多数节点，就是一个成功的写入。多数节点指 Quorum=N/2+1
>
> * 因此推荐的最少节点数是3，因为3的容错节点是1，如果节点数只有1，2的多数节点指的是1和2不允许出错。
>
> * 奇数节点数优于偶数节点 因为6和5的容错节点数都是2，

## 集群节点数量与网络分割

> * 根据raft协议，集群节点越多，会降低节点的写性能，通常配置3，5，7，9
>
> ##### 选择奇数节点原因
>
> 1. 偶数节点容易出现等额票数，进入下一轮选举
> 2. 偶数节点出现网络分割的时候，如果集群节点对半分的话，无法完成选举。集群无法工作
>
> ##### 网络分割
>
> * leader再多数节点，集群可用，少数节点拿不到心跳，也无法完成选举
> * leader节点在少数节点，集群可用，多数节点侧重新选举



