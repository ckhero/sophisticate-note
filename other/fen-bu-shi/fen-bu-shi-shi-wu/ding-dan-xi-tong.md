# 订单系统

# ![](/assets/tcc-shop1.png)

## 简述

> * 接入层
> * 库存系统
>   * 库存冻结后有超时机制
> * 支付系统
>   * **消息表**，记录需要通知库存和订单系统的消息，confirm或者cancel
>   * 支付流水生成后有超时机制
> * 订单系统
>   * 订单初始化后有超时机制

## 流程

> 1. 请求进来后，接入层 进行1，2，3调用，对资源进行预冻结
> 2. 如果都成功，返回前端。其中一个失败，则调用其他两个系统的cancel接口
> 3. 用户进入支付页面
> 4. 支付系统收到第三方支付系统的结果，更新支付流水，并在消息表生成通知消息
> 5. 支付系统脚本处理消息表，根据支付结果的消息，调用库存和订单系统的确认或者cancel接口

## 异常

> * 流程1失败
>   * 网络正常 ，其中一个失败了，会进入流程2 
>   * 网络异常，比如库存扣减成功，返回时候网络传输失败，库存系统调用超时机制，其他两个系统进入流程2
> * 流程2失败
>   * 各系统有超超时机制，会自动释放资源
> * 流程5失败
>   * 支付系统的脚本会不断重试消息表里的数据直到尝试次数上限。达上限后人工介入

## 技术点

> TCC + 本地消息表















