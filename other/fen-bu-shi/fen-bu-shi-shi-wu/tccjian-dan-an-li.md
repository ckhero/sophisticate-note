## TCC简单案例

## 模块

> 游戏系统    积分系统

## 表

> * 游戏系统
>   * 房间记录表
>   * 积分流水表
> * 积分系统
>   * 积分表
>   * 积分流水表

## 流程

> 1. 查询积分
> 2. 游戏系统 生成房间记录 + 积分流水记录  状态都为初始态
> 3. 调用扣除积分接口   （积分系统扣除积分，积分流水表记录扣除的详细信息）
> 4. 游戏系统房间记录 + 积分扣除记录状态流转为终态
> 5. 进入游戏
> 6. 游戏成功
> 7. 游戏系统  保存游戏记录 + 积分增加的流水（初始态）
> 8. 调用积分新增接口   （积分系统新增积分，积分流水表新增流水）
> 9. 游戏系统 积分增加的流水流转为终态

## 异常

> 1. 流程3失败，比如网络清楚这种
>    1. 未扣除  
>    2. 已扣除
>
>    此时游戏系统的积分流水表状态为初始态，脚本轮询该表，获取初始态超时的流水，然后调用积分系统的cancel接口，当然这一不也可以多次重试，重试之后还是不行的依然要走前面的流程
>
> 2. 流程4失败，比如程序崩溃这种
>
>         也会走异常1的case
>
>    3. 流程8 失败
>
>       多次尝试，还是失败的话，脚本会处理该表中超时的初始态的流水





