# AOF

> AOF 记录每次的写操作命令，重启的时候会重新执行这些命令恢复数据

## 策略

> always 每个写命令立即同步，很慢，但很安全
>
> everysec 每秒一次，比较折中
>
> no   redis不处理，交个OS来处理，很快，但不安全

## 缺点

> * 生成的文件大，恢复速度慢
> * 相对而言开启AOF的QPS比RDB的QPS性能低

## 流程

> * 实时写入
>   * 根据策略走，比如everysec
> * 重写
>   * 减少AOF的大小

## 实时写入

> 命令写入-&gt; aof\_buf -&gt; 同步到磁盘



## 重写

> 1. BGWRITEAOF
> 2. 判断AOF/RDB子进程存在。存在直接退出，这是为了避免大量的磁盘IO同时存在
> 3. fork子进程
> 4. 子进程进行重写操作
> 5. 主进程把新的写命令写入aof\__buf和aof\__rewrite_\_buf_
> 6. buf里面的追加到磁盘
> 7. rename

## 注意点

> 1. 重写是把当前内存对应的数据生成对应的命令，不需要取老的aof
> 2. 两个buf同时写入时避免重写失败，数据丢失





